<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Juego: Aprende Mecanograf√≠a</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#f8fafc;
      --muted:#64748b;
      --accent:#3b82f6;
      --ok:#10b981;
      --bad:#ef4444;
      --warn:#f59e0b;
      --ink:#1e293b;
      --border:#e2e8f0;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu,
      Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:linear-gradient(180deg, #ffffff, #f1f5f9);
      color:var(--ink);
      min-height:100svh;
      display:grid; place-items:start center;
      padding:24px;
    }
    .aplicacion{width:min(1100px,96vw);}
    .encabezado{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .titulo{font-size:clamp(20px,2.2vw,28px);font-weight:800;letter-spacing:.3px}
    .subtitulo{font-size:12px;color:var(--muted)}
    .tarjeta{background:var(--card); backdrop-filter: blur(8px); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);}
    .fila{display:flex;gap:12px;flex-wrap:wrap}
    .controles select,.controles button,.controles input[type="number"]{
      background:white;color:var(--ink);border:1px solid var(--border);padding:10px 12px;border-radius:10px; font-weight:600; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }
    .controles button:hover {
      background:#f1f5f9;
    }
    .controles .pildora{padding:8px 10px;border-radius:999px;background:white;border:1px solid var(--border);display:flex;gap:6px;align-items:center; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);}
    .controles label{font-size:12px;color:var(--muted)}
    .cuadricula{display:grid;grid-template-columns:1fr;gap:12px}
    @media (max-width:900px){.cuadricula{grid-template-columns:1fr}}

    /* Texto objetivo */
    #textoObjetivo{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; 
      line-height:1.8; font-size:clamp(16px,2.1vw,20px); padding:18px; border-radius:12px; background:white; min-height:140px;
      border:1px dashed var(--border); position:relative; box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05);}
    #textoObjetivo .completado{color:#94a3b8}
    #textoObjetivo .actual{background:linear-gradient(90deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0)); border-bottom:2px solid var(--accent)}
    #textoObjetivo .correcto{color:var(--ok)}
    #textoObjetivo .incorrecto{color:var(--bad); text-decoration: underline wavy var(--bad) 2px}
    .cursor{position:absolute; width:2px; background:var(--accent); height:1.4em; animation:parpadeo 1s steps(1) infinite; box-shadow:0 0 10px var(--accent)}
    @keyframes parpadeo{50%{opacity:0}}

    /* √Årea de escritura oculta */
    #entradaOculta{position:absolute; left:-9999px}

    /* Estad√≠sticas */
    .estadisticas{display:grid; grid-template-columns: repeat(5, minmax(120px,1fr)); gap:10px}
    @media (max-width:700px){.estadisticas{grid-template-columns:repeat(2,1fr)}}
    .kpi{background:white;border:1px solid var(--border); padding:12px;border-radius:12px; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);}
    .kpi .etiqueta{font-size:12px;color:var(--muted)}
    .kpi .valor{font-size:22px;font-weight:800}

    .progreso{height:10px;background:#e2e8f0;border-radius:999px;overflow:hidden;border:1px solid var(--border)}
    .barra{height:100%;width:0;background:linear-gradient(90deg, var(--accent), #60a5fa)}

    .pie{color:var(--muted);font-size:12px;display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap;margin-top:8px}
    .insignia{background:white;border:1px solid var(--border);padding:4px 8px;border-radius:999px; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);}
  </style>
</head>
<body>
  <div class="aplicacion">
    <div class="encabezado">
      <div>
        <div class="titulo">üéØ Juego: Aprende Mecanograf√≠a</div>
        <div class="subtitulo">JavaScript puro ¬∑ Mide PPM, precisi√≥n y errores ¬∑ Guarda r√©cord en LocalStorage</div>
      </div>
      <div class="fila">
        <button id="btnIniciar">‚ñ∂ Iniciar</button>
        <button id="btnPausa">‚è∏ Pausa</button>
        <button id="btnReiniciar">‚Ü∫ Reiniciar</button>
      </div>
    </div>

    <div class="tarjeta controles">
      <div class="fila" style="align-items:center; justify-content:space-between">
        <div class="fila" style="flex-wrap:wrap">
          <div class="pildora">
            <label for="modo">Modo</label>
            <select id="modo">
              <option value="basico">B√°sico (letras)</option>
              <option value="palabras" selected>Palabras</option>
              <option value="frases">Frases</option>
              <option value="numeros">N√∫meros</option>
              <option value="simbolos">S√≠mbolos</option>
              <option value="personalizado">Personalizado</option>
            </select>
          </div>
          <div class="pildora">
            <label for="nivel">Nivel</label>
            <select id="nivel">
              <option value="1">1</option>
              <option value="2" selected>2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>
          <div class="pildora">
            <label for="longitud">Longitud</label>
            <input id="longitud" type="number" min="20" max="500" value="120" />
          </div>
          <div class="pildora" id="contenedorPersonalizado" style="display:none; min-width:340px">
            <label for="personalizado">Texto personalizado</label>
            <input id="personalizado" type="text" placeholder="Escribe aqu√≠ el texto a practicar‚Ä¶" style="flex:1; background:transparent; color:var(--ink); border:0; outline:none" />
          </div>
        </div>
        <div class="fila">
          <button id="btnNuevo">üß© Nuevo texto</button>
        </div>
      </div>
    </div>

    <div class="cuadricula">
      <!-- √Årea principal de escritura -->
      <div class="tarjeta">
        <div id="textoObjetivo" aria-live="polite"></div>
        <input id="entradaOculta" aria-label="√Årea de escritura" />
        <div class="progreso" style="margin-top:12px"><div class="barra" id="barra"></div></div>
        <div class="pie">
          <span class="insignia">Consejo: empieza a teclear para arrancar el temporizador.</span>
          <span class="insignia">ESC: reinicia ‚Ä¢ TAB: nuevo texto</span>
        </div>
      </div>
      
      <!-- Estad√≠sticas -->
      <div class="tarjeta">
        <div class="estadisticas">
          <div class="kpi"><div class="etiqueta">‚è± Tiempo</div><div class="valor" id="kTiempo">0.0 s</div></div>
          <div class="kpi"><div class="etiqueta">‚ö° PPM</div><div class="valor" id="kPpm">0</div></div>
          <div class="kpi"><div class="etiqueta">‚å®Ô∏è CPM</div><div class="valor" id="kCpm">0</div></div>
          <div class="kpi"><div class="etiqueta">üéØ Precisi√≥n</div><div class="valor" id="kPrecision">100%</div></div>
          <div class="kpi"><div class="etiqueta">‚ùå Errores</div><div class="valor" id="kErrores">0</div></div>
        </div>
        <div class="fila" style="margin-top:12px">
          <div class="kpi" style="flex:1"><div class="etiqueta">üèÜ R√©cord PPM</div><div class="valor" id="kMejor">0</div></div>
          <div class="kpi" style="flex:1"><div class="etiqueta">üìà Progreso</div><div class="valor" id="kProgreso">0%</div></div>
        </div>
      </div>
    </div>
  </div>

  <script>
  // ======== DATOS BASE ========
  // Conjuntos de palabras, frases y caracteres para los diferentes modos
  const PALABRAS = `cami√≥n rueda freno torque ruta carga motor aceite filtro embrague caja cambio volante seguro pista viaje
  neum√°tico eje ballesta buj√≠a bater√≠a rodamiento pist√≥n cig√ºe√±al chasis tr√°iler trailer trailer
  carretera peaje taller taller aliado proveedor cliente factura pedido despacho inventario picking packing
  software log√≠stica bodega pallet estiba conductor tracto mulero`.split(/\s+/);

  const FRASES = [
    "El r√°pido zorro marr√≥n salta sobre el perro perezoso.",
    "Lleva whisky del bueno al jefe por favor.",
    "Quien a buen √°rbol se arrima, buena sombra le cobija.",
    "Mezcla r√°pido: n√∫meros, s√≠mbolos y letras para mejorar.",
    "Repuestos Sim√≥n Bol√≠var: calidad, servicio y confianza." 
  ];

  const NUMEROS = "0123456789 ".repeat(10).trim();
  const SIMBOLOS = "!@#$%^&*()[]{}:;.,-_=+/?\\'\"|<> ".repeat(6).trim();
  const BASICO = "asdf jkl√± ASDF JKL√ë qwer uiop zxcv nm,.;:";

  // ======== ESTADO DE LA APLICACI√ìN ========
  // Objeto que almacena todo el estado actual del juego
  const estado = {
    texto:"",           // Texto actual a escribir
    indice:0,           // Posici√≥n actual en el texto
    iniciado:false,     // Si el juego ha comenzado
    pausado:false,      // Si el juego est√° en pausa
    tiempoInicio:0,     // Marca de tiempo cuando comenz√≥
    tiempoTranscurrido:0, // Tiempo acumulado en milisegundos
    errores:0,          // Contador de errores
    tecleado:0,         // Total de teclas presionadas
    correcto:0,         // Teclas correctamente presionadas
  };

  // ======== ELEMENTOS DEL DOM ========
  // Referencias a todos los elementos HTML que necesitamos manipular
  const textoObjetivo = document.getElementById('textoObjetivo');
  const entradaOculta = document.getElementById('entradaOculta');
  const kTiempo = document.getElementById('kTiempo');
  const kPpm = document.getElementById('kPpm');
  const kCpm = document.getElementById('kCpm');
  const kPrecision = document.getElementById('kPrecision');
  const kErrores = document.getElementById('kErrores');
  const kMejor = document.getElementById('kMejor');
  const kProgreso = document.getElementById('kProgreso');
  const barra = document.getElementById('barra');

  const btnIniciar = document.getElementById('btnIniciar');
  const btnPausa = document.getElementById('btnPausa');
  const btnReiniciar = document.getElementById('btnReiniciar');
  const btnNuevo = document.getElementById('btnNuevo');
  const modo = document.getElementById('modo');
  const nivel = document.getElementById('nivel');
  const longitud = document.getElementById('longitud');
  const personalizado = document.getElementById('personalizado');
  const contenedorPersonalizado = document.getElementById('contenedorPersonalizado');

  // ======== FUNCIONES UTILITARIAS ========
  // Funciones auxiliares para c√°lculos y formateo
  function limitar(n,a,b){return Math.max(a,Math.min(b,n))} // Limita un n√∫mero entre un m√≠nimo y m√°ximo
  function formatoPorcentaje(n){return (n).toFixed(0)+"%"} // Formatea n√∫mero como porcentaje
  function formatearTiempo(ms){return (ms/1000).toFixed(1)+" s"} // Convierte milisegundos a segundos

  // ======== GESTI√ìN DE R√âCORDS ========
  // Guarda y carga el mejor puntaje desde el almacenamiento local
  function guardarMejor(ppm){
    const clave = 'typing_mejor_ppm';
    const mejor = Number(localStorage.getItem(clave)||0);
    if(ppm>mejor){ localStorage.setItem(clave,String(ppm)); return ppm; }
    return mejor;
  }
  function cargarMejor(){ return Number(localStorage.getItem('typing_mejor_ppm')||0) }

  // ======== GENERACI√ìN DE TEXTO ========
  // Crea el texto a escribir seg√∫n el modo y configuraci√≥n seleccionados
  function generarTexto(){
    const lvl = Number(nivel.value);
    const len = limitar(Number(longitud.value)||120, 20, 500);
    let salida = "";
    const m = modo.value;
    if(m==='personalizado'){
      salida = (personalizado.value||"Escribe el texto que deseas practicar.").trim();
    } else if(m==='basico'){
      const caracteres = BASICO.repeat(6 - Math.max(1,6-lvl));
      while(salida.length < len){ salida += seleccionarAleatorio(caracteres) }
    } else if(m==='palabras'){
      while(salida.length < len){ salida += seleccionarDeArray(PALABRAS, lvl) + " "; }
      salida = salida.trim();
    } else if(m==='frases'){
      while(salida.length < len){ salida += seleccionarDeArray(FRASES, 1) + " "; }
      salida = salida.trim();
    } else if(m==='numeros'){
      while(salida.length < len){ salida += seleccionarAleatorio(NUMEROS) }
    } else if(m==='simbolos'){
      while(salida.length < len){ salida += seleccionarAleatorio(SIMBOLOS) }
    }
    return salida.replace(/\s+/g,' ').slice(0,len).trim();
  }
  function seleccionarAleatorio(str){ return str[Math.floor(Math.random()*str.length)] } // Selecciona car√°cter aleatorio
  function seleccionarDeArray(arr, mult=1){ return arr[Math.floor(Math.random()*arr.length*mult)%arr.length] } // Selecciona elemento aleatorio de array

  // ======== RENDERIZADO VISUAL ========
  // Actualiza la interfaz mostrando el texto y progreso actual
  function renderizar(){
    textoObjetivo.innerHTML = '';
    const fragmento = document.createDocumentFragment();
    const completado = document.createElement('span'); completado.className='completado'; completado.textContent = estado.texto.slice(0,estado.indice);
    const actual = document.createElement('span'); actual.className='actual'; actual.textContent = estado.texto[estado.indice] || ' ';
    const resto = document.createElement('span'); resto.textContent = estado.texto.slice(estado.indice+1);
    fragmento.append(completado, actual, resto);
    textoObjetivo.appendChild(fragmento);
    // cursor
    posicionarCursor();
    // progreso
    const progreso = estado.texto.length? (estado.indice/estado.texto.length)*100 : 0;
    barra.style.width = progreso + '%';
    kProgreso.textContent = Math.round(progreso) + '%';
  }

  // Posiciona el cursor visual en la posici√≥n actual de escritura
  function posicionarCursor(){
    const rect = textoObjetivo.getBoundingClientRect();
    const rango = document.createRange();
    const nodo = textoObjetivo.childNodes[0]; // span completado
    const desplazamiento = estado.indice; // cursor al final de completado
    rango.setStart(nodo.firstChild || nodo, desplazamiento);
    rango.setEnd(nodo.firstChild || nodo, desplazamiento);
    const r = rango.getBoundingClientRect();
    let cursor = textoObjetivo.querySelector('.cursor');
    if(!cursor){ cursor = document.createElement('div'); cursor.className='cursor'; textoObjetivo.appendChild(cursor); }
    const izquierda = (r.left||rect.left) - rect.left + 2;
    const arriba = (r.top||rect.top) - rect.top + 4;
    cursor.style.transform = `translate(${izquierda}px, ${arriba}px)`;
  }

  // ======== L√ìGICA PRINCIPAL DEL JUEGO ========
  // Controla el inicio, pausa y reinicio del juego
  function iniciar(){
    if(estado.iniciado && !estado.pausado) return;
    estado.iniciado = true; estado.pausado = false;
    estado.tiempoInicio = performance.now() - estado.tiempoTranscurrido; // reanudar
    ciclo();
    enfocarEntrada();
  }
  function pausar(){ estado.pausado = true; estado.tiempoTranscurrido = performance.now() - estado.tiempoInicio; }
  function reiniciar(nuevoTexto){
    estado.texto = (nuevoTexto !== undefined ? nuevoTexto : generarTexto());
    estado.indice = 0; estado.iniciado=false; estado.pausado=false; estado.tiempoInicio=0; estado.tiempoTranscurrido=0; estado.errores=0; estado.tecleado=0; estado.correcto=0;
    renderizar(); actualizarEstadisticas();
  }

  // Procesa cada tecla presionada y actualiza el estado
  function manejarEntrada(e){
    if(!estado.iniciado || estado.pausado) return;
    const esperado = estado.texto[estado.indice] || '';
    const tecla = e.key;
    estado.tecleado++;

    if(tecla === 'Tab'){ e.preventDefault(); reiniciar(generarTexto()); return; }
    if(tecla === 'Escape'){ e.preventDefault(); reiniciar(); return; }

    if(tecla.length === 1 || tecla === 'Enter' || tecla === 'Backspace' || tecla === ' '){
      const caracterTecleado = tecla === 'Enter' ? '\n' : (tecla === 'Backspace' ? '\b' : tecla);
      // No permitimos retroceder el √≠ndice con Backspace, pero lo contamos como tecleo
      if(caracterTecleado === esperado){
        estado.indice++; estado.correcto++;
        anotarCaracter(true);
      } else {
        estado.errores++;
        anotarCaracter(false);
      }
      renderizar();
      if(estado.indice >= estado.texto.length){ finalizar(); }
    }
  }

  // Marca visualmente el √∫ltimo car√°cter como correcto o incorrecto
  function anotarCaracter(bien){
    const antes = estado.texto.slice(0, estado.indice + (bien?0:0));
    const ultimoIndice = Math.max(0, estado.indice-1);
    const ultimo = estado.texto[ultimoIndice] || '';
    const despues = estado.texto.slice(estado.indice);

    textoObjetivo.innerHTML = '';
    const completado = document.createElement('span'); completado.className='completado';
    const ultimoSpan = document.createElement('span'); ultimoSpan.className = bien ? 'correcto' : 'incorrecto'; ultimoSpan.textContent = ultimo;
    completado.textContent = antes.slice(0,-1);
    completado.appendChild(ultimoSpan);
    const actual = document.createElement('span'); actual.className='actual'; actual.textContent = estado.texto[estado.indice] || ' ';
    const resto = document.createElement('span'); resto.textContent = despues.slice(1);
    textoObjetivo.append(completado,actual,resto);
  }

  // Finaliza el juego cuando se completa el texto
  function finalizar(){
    estado.pausado = true; estado.tiempoTranscurrido = performance.now() - estado.tiempoInicio;
    const ppm = calcularPpm();
    const mejor = guardarMejor(ppm);
    kMejor.textContent = mejor;
    mostrarMensaje(`¬°Completado! PPM ${ppm} ¬∑ Precisi√≥n ${kPrecision.textContent}`);
  }

  // ======== C√ÅLCULO DE ESTAD√çSTICAS ========
  // Calcula las Palabras Por Minuto (PPM)
  function calcularPpm(){
    const ms = (estado.pausado ? estado.tiempoTranscurrido : performance.now() - estado.tiempoInicio);
    const minutos = Math.max(ms/60000, 1/60);
    const palabras = estado.correcto/5; // est√°ndar PPM: 5 caracteres = 1 palabra
    return Math.max(0, Math.round(palabras/minutos));
  }

  // Actualiza todas las estad√≠sticas en pantalla
  function actualizarEstadisticas(){
    const ms = estado.iniciado ? (estado.pausado ? estado.tiempoTranscurrido : performance.now() - estado.tiempoInicio) : estado.tiempoTranscurrido;
    const ppm = estado.iniciado ? calcularPpm() : 0;
    const cpm = estado.iniciado ? Math.round((estado.correcto)/(Math.max(ms/60000,1/60))) : 0;
    const precision = estado.tecleado ? (estado.correcto/estado.tecleado)*100 : 100;

    kTiempo.textContent = formatearTiempo(ms);
    kPpm.textContent = ppm;
    kCpm.textContent = cpm;
    kPrecision.textContent = formatoPorcentaje(precision);
    kErrores.textContent = estado.errores;
  }

  // ======== CICLO PRINCIPAL ========
  // Bucle de actualizaci√≥n continua mientras el juego est√° activo
  let raf = null;
  function ciclo(){
    if(!estado.iniciado || estado.pausado){ cancelAnimationFrame(raf); return; }
    actualizarEstadisticas();
    raf = requestAnimationFrame(ciclo);
  }

  // ======== FUNCIONES DE INTERFAZ ========
  // Enfoca el campo de entrada oculto para capturar teclas
  function enfocarEntrada(){ entradaOculta.focus(); entradaOculta.setSelectionRange(entradaOculta.value.length, entradaOculta.value.length); }

  // Muestra un mensaje temporal en pantalla
  function mostrarMensaje(mensaje){
    const notificacion = document.createElement('div');
    notificacion.textContent = mensaje;
    notificacion.style.cssText = 'position:fixed;left:50%;top:12px;transform:translateX(-50%);background:white;border:1px solid var(--border);padding:10px 14px;border-radius:10px;z-index:99;box-shadow:0 10px 30px rgba(0,0,0,.1);color:var(--ink);';
    document.body.appendChild(notificacion);
    setTimeout(()=>notificacion.remove(), 2200);
  }

  // ======== CONFIGURACI√ìN DE EVENTOS ========
  // Configura todos los event listeners del juego
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Tab'){ e.preventDefault(); }
    if(e.key === 'Escape'){ e.preventDefault(); }
    if(!estado.iniciado && e.key.length===1){ iniciar(); }
  }, true);

  entradaOculta.addEventListener('keydown', (e)=>{
    if(e.repeat) return; // evitar repetici√≥n sostenida
    manejarEntrada(e);
  });

  textoObjetivo.addEventListener('click', enfocarEntrada);
  btnIniciar.addEventListener('click', ()=>{ iniciar(); enfocarEntrada(); });
  btnPausa.addEventListener('click', ()=>{ pausar(); actualizarEstadisticas(); });
  btnReiniciar.addEventListener('click', ()=> reiniciar());
  btnNuevo.addEventListener('click', ()=> reiniciar(generarTexto()));

  modo.addEventListener('change', ()=>{ contenedorPersonalizado.style.display = modo.value==='personalizado'?'flex':'none'; reiniciar(generarTexto()); });
  nivel.addEventListener('change', ()=> reiniciar(generarTexto()));
  longitud.addEventListener('change', ()=> reiniciar(generarTexto()));
  personalizado.addEventListener('change', ()=> reiniciar(generarTexto()));

  // ======== INICIALIZACI√ìN ========
  // Configuraci√≥n inicial cuando se carga la p√°gina
  reiniciar(generarTexto());
  kMejor.textContent = cargarMejor();
  enfocarEntrada();
  </script>
</body>
</html>
